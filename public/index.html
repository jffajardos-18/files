<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Hot Companies — Company Profiles</title>

  <style>
    :root{
      color-scheme: light;

      /* Core palette (solid, no gradients) */
      --navy: #162780;   /* Pantone 2748 C */
      --royal: #002AD8;  /* Pantone 2728 C */
      --aqua: #92F6FF;   /* Pantone 635 C */
      --cyan: #00CCCC;   /* Pantone 3262 C */
      --teal: #015958;   /* Pantone 323 C */

      /* Neutrals */
      --bg: #FFFFFF;
      --ink: #000000;
      --muted: #4a4a4a;
      --gray: #808080;
      --line: #E6E6E6;

      --radius: 14px;
    }

    /* IMPORTANT: set html background (not just body) */
    html{
      background: var(--bg);
      color: var(--ink);
      height: 100%;
    }

    body{
      margin: 0;
      min-height: 100%;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    a{ color: inherit; text-decoration: none; }
    a:hover{ text-decoration: underline; }
    *{ box-sizing: border-box; }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--navy);
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,.15);
    }

    .topbar-inner{
      max-width: 1160px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .brand{
      display:flex;
      align-items: baseline;
      gap: 10px;
    }

    .brand h1{
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
      font-weight: 800;
    }

    .brand .sub{
      font-size: 12px;
      color: rgba(255,255,255,.85);
      white-space: nowrap;
    }

    .controls{
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .input{
      background: #fff;
      color: #000;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px 10px;
      min-width: 280px;
      outline: none;
    }
    .input:focus{
      border-color: var(--royal);
      box-shadow: 0 0 0 2px rgba(0,42,216,.18);
    }

    .btn{
      border: 1px solid rgba(255,255,255,.25);
      background: transparent;
      color: #fff;
      padding: 9px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .2px;
    }
    .btn:hover{ border-color: rgba(255,255,255,.45); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      color: #fff;
      white-space: nowrap;
    }

    .main{
      max-width: 1160px;
      margin: 0 auto;
      padding: 18px;
    }

    .meta-row{
      display:flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin: 10px 0 14px;
    }

    .meta{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .meta a{
      color: var(--navy);
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .error{
      color: #b00020;
      font-size: 13px;
      white-space: pre-wrap;
      border: 1px solid #f1c4cb;
      background: #fff5f6;
      padding: 10px 12px;
      border-radius: var(--radius);
      display:none;
    }

    .grid{
      display:flex;
      flex-direction: column;
      gap: 12px;
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: #fff;
      overflow: hidden;
    }

    .card-head{
      padding: 14px 14px 12px;
      display:flex;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--line);
    }

    .titleblock{
      min-width: 260px;
      flex: 1 1 520px;
    }

    .title-row{
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .company{
      margin: 0;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .1px;
      color: var(--ink);
    }

    .badges{
      display:flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid transparent;
      letter-spacing: .2px;
      white-space: nowrap;
    }

    .badge.label-HOT{ background: var(--royal); color:#fff; }
    .badge.label-WARM{ background: var(--teal); color:#fff; }
    .badge.label-COLD{ background: var(--gray); color:#fff; }
    .badge.label-NOISE{ background: var(--aqua); color: var(--navy); border-color: rgba(22,39,128,.25); }
    .badge.label-UNKNOWN{ background: #f3f3f3; color: #000; border-color: var(--line); }

    .badge.metric{
      background: #fff;
      border-color: var(--line);
      color: var(--navy);
      font-weight: 900;
    }

    .links{
      display:flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
      flex: 0 0 auto;
    }

    .chip{
      display:inline-flex;
      gap: 8px;
      align-items:center;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--navy);
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 800;
      text-decoration: none;
    }
    .chip:hover{
      border-color: rgba(0,42,216,.45);
      text-decoration: none;
    }

    .kv{
      padding: 12px 14px 14px;
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 1100px){
      .kv{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (max-width: 720px){
      .kv{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .kv-item{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px 9px;
      background: #fff;
    }
    .kv-k{
      font-size: 11px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .15px;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    .kv-v{
      font-size: 13px;
      font-weight: 900;
      color: #000;
      word-break: break-word;
    }

    .bars{
      padding: 0 14px 14px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 720px){
      .bars{ grid-template-columns: 1fr; }
    }

    .barbox{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }

    .bar-top{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    .bar-k{
      font-size: 11px;
      color: var(--muted);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .15px;
    }
    .bar-v{
      font-size: 13px;
      font-weight: 900;
      color: #000;
      white-space: nowrap;
    }

    .bar{
      margin-top: 8px;
      height: 10px;
      border-radius: 999px;
      background: #f2f2f2;
      border: 1px solid var(--line);
      overflow: hidden;
    }
    .bar-fill{
      height: 100%;
      width: 0%;
      background: var(--royal);
    }
    .bar-fill.teal{ background: var(--teal); }

    details.section{
      border-top: 1px solid var(--line);
      background: #fff;
    }

    details.section > summary{
      list-style: none;
      padding: 12px 14px;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      font-weight: 900;
      color: var(--navy);
      user-select: none;
    }
    details.section > summary::-webkit-details-marker{ display:none; }

    .section-body{
      padding: 0 14px 14px;
      color: #000;
    }

    .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .subhead{
      margin: 12px 0 6px;
      font-weight: 900;
      color: var(--ink);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .15px;
    }

    .list{
      margin: 6px 0 0;
      padding-left: 16px;
      color: #000;
      font-size: 13px;
      line-height: 1.45;
    }
    .list li{ margin: 6px 0; }

    .src-grid{
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .src-item{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }

    .src-title{
      font-weight: 900;
      font-size: 13px;
      color: var(--ink);
      margin-bottom: 2px;
      word-break: break-word;
    }

    .src-why{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .chips{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .mini{
      display:inline-flex;
      align-items:center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--navy);
    }

    .loadmore{
      margin: 14px 0 0;
      display:flex;
      justify-content: center;
    }

    .loadmore button{
      background: var(--royal);
      border: 1px solid rgba(0,42,216,.25);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .loadmore button:hover{ background: #001fb0; }

    .footer-note{
      margin: 14px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <h1>Hot Companies — Company Profiles</h1>
        <div class="sub" id="subtitle">Sorted by hot_score ↓ then company_priority_test ↓</div>
      </div>

      <div class="controls">
        <span class="pill" id="status">Loading…</span>
        <input class="input" id="q" placeholder="Search companies, reasons, sources, HQ, industry…" />
        <button class="btn" id="clearBtn" type="button">Clear</button>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="meta-row">
      <div class="meta">
        Source:
        <a id="srcLink" target="_blank" rel="noopener"></a>
      </div>
      <div class="meta" id="meta"></div>
    </div>

    <div class="error" id="err"></div>

    <div class="grid" id="cards"></div>

    <div class="loadmore" id="loadMoreWrap" style="display:none;">
      <button type="button" id="loadMoreBtn">Load more</button>
    </div>

    <div class="footer-note">
      Notes: Only the requested columns are displayed. Profiles are rendered in batches for performance.
    </div>
  </div>

<script>
(() => {
  // ---- IMPORTANT FIX ----
  // Your Pages root sometimes flips between:
  //   /<repo>/  (serving gh-pages /(root))  -> CSV at /<repo>/public/data/hot_companies.csv
  //   /<repo>/  (serving gh-pages /public) -> CSV at /<repo>/data/hot_companies.csv
  // We auto-detect which one exists so it never breaks again.

  const PATH_ROOT = (() => {
    const parts = window.location.pathname.split("/").filter(Boolean);
    // On *.github.io project pages, first segment is the repo name.
    if (window.location.hostname.endsWith("github.io") && parts.length) return "/" + parts[0];
    return "";
  })();

  const CSV_CANDIDATES = [
    `${PATH_ROOT}/public/data/hot_companies.csv`,
    `${PATH_ROOT}/data/hot_companies.csv`
  ];

  let CSV_URL = CSV_CANDIDATES[0]; // will be replaced by the first working candidate

  const IMPORTANT_COLUMNS = [
    "company_name",
    "norm_company_website",
    "norm_company_linkedin",
    "hq",
    "ownership",
    "l1_proxi",
    "industry_proxi",
    "fte",
    "fte_growth",
    "transaction_date",
    "transaction_type",
    "n_ai_survey",
    "max_ai_survey_score",
    "is_published_on_origin",
    "n_competitors",
    "pa_batch",
    "n_project_index",
    "company_priority_test",
    "hot_score",
    "arguments",
    "mna_signal_snippets"
  ];

  const srcLink = document.getElementById("srcLink");
  const statusEl = document.getElementById("status");
  const metaEl = document.getElementById("meta");
  const errEl = document.getElementById("err");
  const cardsEl = document.getElementById("cards");
  const qEl = document.getElementById("q");
  const clearBtn = document.getElementById("clearBtn");
  const loadMoreWrap = document.getElementById("loadMoreWrap");
  const loadMoreBtn = document.getElementById("loadMoreBtn");

  let all = [];       // sorted full dataset
  let filtered = [];  // filtered in the same sorted order
  let renderLimit = 40;
  const RENDER_STEP = 40;

  function setStatus(text){ statusEl.textContent = text; }
  function showError(msg){
    errEl.style.display = "block";
    errEl.textContent = msg;
  }
  function clearError(){
    errEl.style.display = "none";
    errEl.textContent = "";
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function safeJsonParse(s){
    const t = String(s ?? "").trim();
    if (!t) return null;
    try { return JSON.parse(t); } catch { return null; }
  }

  function asNum(s){
    const n = Number(String(s ?? "").trim());
    return Number.isFinite(n) ? n : null;
  }

  function boolish(v){
    const s = String(v ?? "").trim().toLowerCase();
    if (!s) return null;
    return (s === "true" || s === "t" || s === "1" || s === "yes" || s === "y");
  }

  function normalizeUrl(u){
    const s = String(u ?? "").trim();
    if (!s) return "";
    if (s.startsWith("http://") || s.startsWith("https://")) return s;
    return "https://" + s;
  }

  function fmtNum(n, digits=2){
    if (n === null || n === undefined || !Number.isFinite(n)) return "";
    return n.toFixed(digits);
  }

  function clamp01(n){
    if (!Number.isFinite(n)) return 0;
    return Math.max(0, Math.min(1, n));
  }

  // Robust-ish CSV parser: handles quoted fields, commas, newlines in quotes.
  function parseCSV(text){
    const out = [];
    let i = 0, field = "", row = [];
    let inQuotes = false;

    while (i < text.length){
      const c = text[i];

      if (inQuotes){
        if (c === '"'){
          if (text[i + 1] === '"'){ field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        }
        field += c; i++; continue;
      } else {
        if (c === '"'){ inQuotes = true; i++; continue; }
        if (c === ","){ row.push(field); field = ""; i++; continue; }
        if (c === "\r"){ i++; continue; }
        if (c === "\n"){ row.push(field); out.push(row); field = ""; row = []; i++; continue; }
        field += c; i++; continue;
      }
    }
    row.push(field);
    out.push(row);
    return out;
  }

  function buildIndex(headers){
    const map = new Map();
    headers.forEach((h, idx) => map.set(String(h ?? "").trim(), idx));
    return map;
  }

  function getCell(row, idxMap, key){
    const idx = idxMap.get(key);
    if (idx === undefined) return "";
    return row[idx] ?? "";
  }

  function labelFromArguments(arg){
    const raw = arg?.label;
    return raw ? String(raw).toUpperCase() : "UNKNOWN";
  }

  function buildSearchBlob(r){
    const parts = [];

    for (const k of IMPORTANT_COLUMNS){
      if (k === "arguments" || k === "mna_signal_snippets") continue;
      parts.push(String(r[k] ?? ""));
    }

    if (r._arguments){
      parts.push(String(r._arguments.label ?? ""));
      parts.push(String(r._arguments.summary ?? ""));
      parts.push(String(r._arguments.deal_stage ?? ""));
      parts.push(String(r._arguments.deal_role ?? ""));
      parts.push(String(r._arguments.counterparty ?? ""));
      parts.push(String(r._arguments.agent_analyst_comment ?? ""));
      const reasons = Array.isArray(r._arguments.reasons) ? r._arguments.reasons : [];
      for (const rr of reasons){
        parts.push(String(rr?.text ?? ""));
        parts.push(String(rr?.source_url ?? ""));
      }
      const sources = Array.isArray(r._arguments.sources) ? r._arguments.sources : [];
      for (const ss of sources){
        parts.push(String(ss?.title ?? ""));
        parts.push(String(ss?.url ?? ""));
        parts.push(String(ss?.why ?? ""));
      }
    }

    if (r._mna){
      parts.push(String(r._mna.website ?? ""));
      parts.push(String(r._mna.base_root ?? ""));
      parts.push(String(r._mna.company_name ?? ""));
      const msrc = Array.isArray(r._mna.sources) ? r._mna.sources : [];
      for (const s of msrc){
        parts.push(String(s?.title ?? ""));
        parts.push(String(s?.final_url ?? s?.requested_url ?? ""));
        parts.push(String(s?.source_type ?? ""));
      }
    }

    return parts.join(" ").toLowerCase();
  }

  function cardHTML(r){
    const company = String(r.company_name ?? "").trim() || "(missing company_name)";
    const hot = r._hot_score;
    const pri = r._company_priority;

    const label = r._label || "UNKNOWN";
    const labelClass = `label-${label}`;

    const website = normalizeUrl(r.norm_company_website);
    const linkedin = normalizeUrl(r.norm_company_linkedin);

    const published = boolish(r.is_published_on_origin);
    const publishedTxt = published === null ? "" : (published ? "Yes" : "No");

    const hotPct = Math.round(clamp01(hot ?? 0) * 100);
    const priPct = Math.round(clamp01(pri ?? 0) * 100);

    const args = r._arguments;
    const reasons = Array.isArray(args?.reasons) ? args.reasons : [];
    const sources = Array.isArray(args?.sources) ? args.sources : [];

    const mna = r._mna;
    const mnaFlags = (mna && typeof mna.flags === "object") ? mna.flags : null;
    const mnaSources = Array.isArray(mna?.sources) ? mna.sources : [];

    const reasonHTML = reasons.length
      ? `<ul class="list">${
          reasons.map(x => {
            const t = esc(x?.text ?? "");
            const u = String(x?.source_url ?? "").trim();
            const link = u ? ` <a href="${esc(u)}" target="_blank" rel="noopener">source</a>` : "";
            return `<li>${t}${link}</li>`;
          }).join("")
        }</ul>`
      : `<div class="small">No reasons provided.</div>`;

    const sourceHTML = sources.length
      ? `<div class="src-grid">${
          sources.map(s => {
            const url = String(s?.url ?? "").trim();
            const title = String(s?.title ?? "").trim() || url || "(source)";
            const why = String(s?.why ?? "").trim();
            const safeUrl = url ? esc(url) : "";
            return `
              <div class="src-item">
                <div class="src-title">
                  ${url ? `<a href="${safeUrl}" target="_blank" rel="noopener">${esc(title)}</a>` : esc(title)}
                </div>
                ${why ? `<div class="src-why">${esc(why)}</div>` : `<div class="src-why">—</div>`}
              </div>
            `;
          }).join("")
        }</div>`
      : `<div class="small">No sources provided.</div>`;

    let flagsHTML = "";
    if (mnaFlags){
      const chips = [];
      for (const [k, v] of Object.entries(mnaFlags)){
        if (typeof v === "boolean") chips.push(`<span class="mini">${esc(k)}: ${v ? "true" : "false"}</span>`);
      }
      if (chips.length) flagsHTML = `<div class="chips">${chips.join("")}</div>`;
    }

    const mnaSourcesHTML = mnaSources.length
      ? `<div class="src-grid">${
          mnaSources.map(s => {
            const url = String(s?.final_url ?? s?.requested_url ?? "").trim();
            const title = String(s?.title ?? "").trim() || url || "(source)";
            const meta = [
              s?.status != null ? `status ${s.status}` : "",
              s?.source_type ? String(s.source_type) : ""
            ].filter(Boolean).join(" · ");
            return `
              <div class="src-item">
                <div class="src-title">
                  ${url ? `<a href="${esc(url)}" target="_blank" rel="noopener">${esc(title)}</a>` : esc(title)}
                </div>
                <div class="src-why">${esc(meta || "—")}</div>
              </div>
            `;
          }).join("")
        }</div>`
      : `<div class="small">No sources in mna_signal_snippets.</div>`;

    const argsSummary = String(args?.summary ?? "").trim();
    const analyst = String(args?.agent_analyst_comment ?? "").trim();

    return `
      <div class="card">
        <div class="card-head">
          <div class="titleblock">
            <div class="title-row">
              <h2 class="company">${esc(company)}</h2>
              <div class="badges">
                <span class="badge ${esc(labelClass)}">${esc(label)}</span>
                <span class="badge metric">hot_score: ${hot == null ? "—" : esc(fmtNum(hot, 3))}</span>
                <span class="badge metric">priority: ${pri == null ? "—" : esc(fmtNum(pri, 3))}</span>
              </div>
            </div>

            <div class="small" style="margin-top:6px;">
              ${r.hq ? `<span><b>HQ:</b> ${esc(r.hq)}</span>` : ""}
              ${r.ownership ? ` &nbsp;·&nbsp; <span><b>Ownership:</b> ${esc(r.ownership)}</span>` : ""}
              ${r.industry_proxi ? ` &nbsp;·&nbsp; <span><b>Industry:</b> ${esc(r.industry_proxi)}</span>` : ""}
            </div>
          </div>

          <div class="links">
            ${website ? `<a class="chip" href="${esc(website)}" target="_blank" rel="noopener">Website</a>` : ""}
            ${linkedin ? `<a class="chip" href="${esc(linkedin)}" target="_blank" rel="noopener">LinkedIn</a>` : ""}
            <a class="chip" href="${esc(CSV_URL)}" target="_blank" rel="noopener">CSV</a>
          </div>
        </div>

        <div class="kv">
          <div class="kv-item"><div class="kv-k">L1</div><div class="kv-v">${esc(r.l1_proxi || "—")}</div></div>
          <div class="kv-item"><div class="kv-k">Industry</div><div class="kv-v">${esc(r.industry_proxi || "—")}</div></div>
          <div class="kv-item"><div class="kv-k">FTE</div><div class="kv-v">${esc(r.fte || "—")}</div></div>
          <div class="kv-item"><div class="kv-k">FTE growth</div><div class="kv-v">${r.fte_growth ? fmtNum(asNum(r.fte_growth) * 100, 2) + '%' : "—"}</div></div>
          <div class="kv-item"><div class="kv-k">Competitors</div><div class="kv-v">${esc(r.n_competitors || "—")}</div></div>
          <div class="kv-item"><div class="kv-k">Project index</div><div class="kv-v">${r.n_project_index ? fmtNum(asNum(r.n_project_index), 2) : "—"}</div></div>

          <div class="kv-item"><div class="kv-k">Transaction date</div><div class="kv-v">${esc(r.transaction_date || "—")}</div></div>
          <div class="kv-item"><div class="kv-k">Transaction type</div><div class="kv-v">${esc(r.transaction_type || "—")}</div></div>
          <div class="kv-item"><div class="kv-k">AI surveys</div><div class="kv-v">${esc(r.n_ai_survey || "—")}</div></div>
          <div class="kv-item"><div class="kv-k">Max AI score</div><div class="kv-v">${esc(r.max_ai_survey_score || "—")}</div></div>
          <div class="kv-item"><div class="kv-k">Published on Origin</div><div class="kv-v">${esc(publishedTxt || "—")}</div></div>
          <div class="kv-item"><div class="kv-k">PA batch</div><div class="kv-v">${esc(r.pa_batch || "—")}</div></div>
        </div>

        <div class="bars">
          <div class="barbox">
            <div class="bar-top">
              <div class="bar-k">hot_score</div>
              <div class="bar-v">${hot == null ? "—" : esc(fmtNum(hot, 3))} (${hotPct}%)</div>
            </div>
            <div class="bar"><div class="bar-fill teal" style="width:${hotPct}%;"></div></div>
          </div>

          <div class="barbox">
            <div class="bar-top">
              <div class="bar-k">COMPANY PRIORITY</div>
              <div class="bar-v">${pri == null ? "—" : esc(fmtNum(pri, 3))} (${priPct}%)</div>
            </div>
            <div class="bar"><div class="bar-fill" style="width:${priPct}%;"></div></div>
          </div>
        </div>

        <details class="section" open>
          <summary>
            <span>Arguments (model output)</span>
            <span class="small"><b>Stage:</b> ${args?.deal_stage ?? "—"}</span>
          </summary>
          <div class="section-body">
            ${argsSummary ? `<div class="small"><b>Summary:</b> ${esc(argsSummary)}</div>` : `<div class="small"><b>Summary:</b> —</div>`}
            ${analyst ? `<div class="small" style="margin-top:6px;"><b>Analyst comment:</b> ${esc(analyst)}</div>` : ""}

            <div class="chips">
              <span class="mini">deal_role: ${esc(args?.deal_role ?? "—")}</span>
              <span class="mini">deal_date: ${esc(args?.deal_date ?? "—")}</span>
              <span class="mini">counterparty: ${esc(args?.counterparty ?? "—")}</span>
            </div>

            <div class="subhead">Reasons</div>
            ${reasonHTML}

            <div class="subhead">Sources</div>
            ${sourceHTML}
          </div>
        </details>

        <details class="section">
          <summary>
            <span>M&A signal snippets</span>
            <span class="small">${esc(mna?.website ?? "")}</span>
          </summary>
          <div class="section-body">
            <div class="small">
              ${mna?.base_root ? `<b>Base:</b> ${esc(mna.base_root)} &nbsp;·&nbsp; ` : ""}
              ${mna?.retrieved_at_utc ? `<b>Retrieved:</b> ${esc(mna.retrieved_at_utc)}` : ""}
            </div>

            ${flagsHTML ? `<div class="subhead">Flags</div>${flagsHTML}` : ""}

            <div class="subhead">Sources</div>
            ${mnaSourcesHTML}
          </div>
        </details>
      </div>
    `;
  }

  function render(){
    cardsEl.innerHTML = "";

    const showN = Math.min(renderLimit, filtered.length);
    const slice = filtered.slice(0, showN);

    cardsEl.innerHTML = slice.map(cardHTML).join("");

    metaEl.textContent =
      `Companies: ${filtered.length.toLocaleString()} / ${all.length.toLocaleString()} | Showing: ${showN.toLocaleString()} | Sorted: hot_score ↓, company_priority_test ↓`;

    if (showN < filtered.length){
      loadMoreWrap.style.display = "flex";
      loadMoreBtn.textContent = `Load more (${Math.min(RENDER_STEP, filtered.length - showN)})`;
    } else {
      loadMoreWrap.style.display = "none";
    }
  }

  function applyFilter(){
    const needle = qEl.value.trim().toLowerCase();
    renderLimit = 40;

    if (!needle){
      filtered = all;
    } else {
      filtered = all.filter(r => r._search.includes(needle));
    }
    render();
  }

  loadMoreBtn.addEventListener("click", () => {
    renderLimit += RENDER_STEP;
    render();
  });

  clearBtn.addEventListener("click", () => {
    qEl.value = "";
    applyFilter();
    qEl.focus();
  });

  qEl.addEventListener("input", () => applyFilter());

  async function fetchFirstOk(urls){
    let lastErr = null;
    for (const u of urls){
      try{
        const r = await fetch(u, { cache: "no-store" });
        if (r.ok) return { url: u, res: r };
        lastErr = new Error(`Fetch failed: ${r.status} ${r.statusText} (${u})`);
      } catch (e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("Failed to fetch CSV.");
  }

  async function main(){
    try{
      clearError();
      setStatus("Locating CSV…");

      const { url, res } = await fetchFirstOk(CSV_CANDIDATES);
      CSV_URL = url;

      srcLink.href = CSV_URL;
      srcLink.textContent = CSV_URL;

      setStatus("Downloading CSV…");
      const text = await res.text();
      if (!text.trim()) throw new Error("CSV appears empty.");

      setStatus("Parsing…");
      const parsed = parseCSV(text);
      if (!parsed.length) throw new Error("CSV appears empty.");

      const headers = parsed[0].map(h => String(h ?? "").trim());
      const idxMap = buildIndex(headers);

      const records = [];
      for (const row of parsed.slice(1)){
        const r = {};
        for (const k of IMPORTANT_COLUMNS){
          r[k] = getCell(row, idxMap, k);
        }

        r._arguments = safeJsonParse(r.arguments);
        r._mna = safeJsonParse(r.mna_signal_snippets);

        r._label = labelFromArguments(r._arguments);

        r._hot_score = asNum(r.hot_score);
        r._company_priority = asNum(r.company_priority_test);

        r._search = buildSearchBlob(r);

        records.push(r);
      }

      records.sort((a, b) => {
        const ah = (a._hot_score == null) ? -Infinity : a._hot_score;
        const bh = (b._hot_score == null) ? -Infinity : b._hot_score;
        if (bh !== ah) return bh - ah;

        const ap = (a._company_priority == null) ? -Infinity : a._company_priority;
        const bp = (b._company_priority == null) ? -Infinity : b._company_priority;
        if (bp !== ap) return bp - ap;

        const an = String(a.company_name ?? "");
        const bn = String(b.company_name ?? "");
        return an.localeCompare(bn);
      });

      all = records;
      filtered = all;

      setStatus("Ready");
      render();

    } catch (e){
      setStatus("Error");
      showError(String(e?.message || e));
    }
  }

  main();
})();
</script>
</body>
</html>
