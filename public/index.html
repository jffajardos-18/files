<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hot Companies — CSV Viewer</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 24px;
    }
    h1 { margin-bottom: 6px; }
    .muted { color: #555; }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin: 12px 0 16px;
    }
    input { padding: 8px 10px; min-width: 260px; }
    button { padding: 8px 10px; cursor: pointer; }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      vertical-align: top;
    }
    th {
      position: sticky;
      top: 0;
      background: #f7f7f7;
      cursor: pointer;
      user-select: none;
    }
    tr:nth-child(even) td { background: #fafafa; }
    .pill {
      display:inline-block;
      padding:2px 8px;
      border:1px solid #ddd;
      border-radius:999px;
      font-size:12px;
    }
    .error {
      color: #b00020;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <h1>Hot Companies — CSV Viewer</h1>

  <div class="muted">
    Source:
    <a id="srcLink" target="_blank" rel="noopener"></a>
  </div>

  <div class="row">
    <span class="pill" id="status">Loading…</span>
    <label class="muted">Search:</label>
    <input id="q" placeholder="type to filter rows" />
    <button id="clearBtn">Clear</button>
  </div>

  <div class="muted" id="meta"></div>
  <div class="error" id="err"></div>

  <div style="margin-top:14px; overflow:auto; max-height:70vh;">
    <table id="tbl"></table>
  </div>

<script>
(() => {
  // ✅ STABLE, WORKING PATH
  const CSV_URL = "/files/public/data/hot_companies.csv";

  const srcLink = document.getElementById("srcLink");
  srcLink.href = CSV_URL;
  srcLink.textContent = CSV_URL;

  const statusEl = document.getElementById("status");
  const metaEl   = document.getElementById("meta");
  const errEl    = document.getElementById("err");
  const tbl      = document.getElementById("tbl");
  const q        = document.getElementById("q");
  const clearBtn = document.getElementById("clearBtn");

  let headers = [];
  let rows = [];
  let viewRows = [];
  let sort = { col: -1, dir: 1 };

  function setStatus(t) { statusEl.textContent = t; }

  function parseCSV(text) {
    const out = [];
    let row = [], field = "", inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];

      if (inQuotes) {
        if (c === '"' && text[i+1] === '"') { field += '"'; i++; }
        else if (c === '"') inQuotes = false;
        else field += c;
      } else {
        if (c === '"') inQuotes = true;
        else if (c === ",") { row.push(field); field = ""; }
        else if (c === "\n") { row.push(field); out.push(row); row = []; field = ""; }
        else if (c !== "\r") field += c;
      }
    }
    row.push(field);
    out.push(row);
    return out;
  }

  function render() {
    const LIMIT = 200;

    const thead = "<thead><tr>" +
      headers.map((h,i)=>`<th data-i="${i}">${h}${sort.col===i?(sort.dir>0?" ▲":" ▼"):""}</th>`).join("")
      + "</tr></thead>";

    const tbody = "<tbody>" +
      viewRows.slice(0, LIMIT).map(r =>
        "<tr>" + r.map(c => `<td>${c ?? ""}</td>`).join("") + "</tr>"
      ).join("") +
      "</tbody>";

    tbl.innerHTML = thead + tbody;

    metaEl.textContent =
      `Rows: ${rows.length.toLocaleString()} | Showing ${Math.min(viewRows.length, LIMIT)} of ${viewRows.length.toLocaleString()}`;

    tbl.querySelectorAll("th").forEach(th => {
      th.onclick = () => {
        const i = +th.dataset.i;
        sort.dir = sort.col === i ? -sort.dir : 1;
        sort.col = i;
        applySort();
        render();
      };
    });
  }

  function applySort() {
    if (sort.col < 0) return;
    viewRows.sort((a,b)=> {
      if (a[sort.col] < b[sort.col]) return -sort.dir;
      if (a[sort.col] > b[sort.col]) return  sort.dir;
      return 0;
    });
  }

  async function main() {
    try {
      setStatus("Downloading CSV…");
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);

      const text = await res.text();
      const parsed = parseCSV(text);

      headers = parsed[0];
      rows = parsed.slice(1);
      viewRows = rows.slice();

      setStatus("Ready");
      render();

      q.oninput = () => {
        const s = q.value.toLowerCase();
        viewRows = rows.filter(r => r.some(c => String(c).toLowerCase().includes(s)));
        applySort();
        render();
      };

      clearBtn.onclick = () => {
        q.value = "";
        viewRows = rows.slice();
        render();
      };

    } catch (e) {
      setStatus("Error");
      errEl.textContent = e.message;
    }
  }

  main();
})();
</script>
</body>
</html>
